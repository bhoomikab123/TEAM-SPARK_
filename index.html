<html>
{% extends 'base.html' %}
{% block pagetitle %}
AI Engine
{% endblock pagetitle %}

{% block body %}
<div>
    <div class="container">
        <!-- For demo purpose -->
        <div class="row mb-5 text-center text-white">
            <div class="col-lg-10 mx-auto">
                <h1 class="display-4" style="padding-top: 2%;font-weight: 400;color: rgb(4, 54, 4);"><b>üçÄAI
                        EngineüçÄ</b></h1>
                <p class="lead" style="font-weight: 500;color: black;">Let AI Engine Will Help You To Detect Disease</p>
            </div>
        </div>
        <!-- End -->
        <div class="row ">
            <div class="col mx-auto">
                <div class="p-5 bg-white shadow rounded-lg" style="height: 95%;">

                    <h5><b>Why is it necessary to detect disease in plant ?</b></h5>
                    <p>Plant diseases affect the growth of their respective species. In addition, some research gaps are
                        identified from which to obtain greater transparency for detecting diseases in plants, even
                        before their symptoms appear clearly.
                        diagnosis is one of the most important aspects of a plant pathologist's training. Without proper
                        identification of the disease and the disease-causing agent, disease control measures can be a
                        waste of time and money and can lead to further plant losses. Proper disease diagnosis is
                        necessary.
                    </p>
                </div>
            </div>
            <div class="col mx-auto">
                <div class="p-5 bg-white shadow rounded-lg" style="height: 95%;"><img
                        src="https://www.pngjoy.com/pngl/250/4840262_plants-png-indoors-tropical-plant-png-hd-png.png "
                        height="300" alt="" width="200" class="d-block mx-auto mb-4 rounded-pill">

                    <!-- Default bootstrap file upload-->

                    <form action="/submit" method="POST" enctype="multipart/form-data" id="upload-form">
                        <div class="custom-file overflow-hidden mb-4">
                            <input type="file" id="actual-btn" hidden name="image" accept="image/*" required />
                            <label for="actual-btn" style="display: inline-block; margin-right: 10px;">Choose File</label>
                            <label id="camera-btn" style="display: inline-block; cursor: pointer;">Open Camera</label>
                            <br>
                            <span id="file-chosen" style="display: block; margin-top: 10px; color: #333;">No file chosen</span>
                        </div>

                        <!-- Camera feed container (hidden initially) -->
                        <div id="camera-container" style="display: none; margin: 20px 0;">
                            <video id="camera-feed" width="320" height="240" autoplay style="border-radius: 10px;"></video>
                            <br>
                            <button type="button" id="capture-btn" class="btn btn-primary" style="margin-top: 10px;">Capture Photo</button>
                            <button type="button" id="close-camera-btn" class="btn btn-secondary" style="margin-top: 10px;">Close Camera</button>
                        </div>

                        <!-- Preview Image (will show the captured photo) -->
                        <div id="preview-container" style="display: none; margin: 20px 0;">
                            <img id="preview" src="#" alt="Image Preview" style="max-width: 100%; max-height: 300px; border-radius: 10px; border: 2px solid #05380b;" />
                        </div>

                        <h6 class="text-center mb-4 text-muted">
                            Simply upload your plant's leaf image and then see the magic of AI.
                        </h6>

                        <!-- Custom bootstrap upload file-->
                        <center>
                            <button type="submit" class="btn btn-outline-success" id="submit-btn">Submit</button>
                        </center>
                    </form>
                    <!-- End -->

                </div>
            </div>
            
            </div>
        </div>
    </div>
</div>

<script>
    const actualBtn = document.getElementById('actual-btn');
    const captureBtn = document.getElementById('capture-btn');
    const cameraBtn = document.getElementById('camera-btn');
    const fileChosen = document.getElementById('file-chosen');
    const cameraContainer = document.getElementById('camera-container');
    const cameraFeed = document.getElementById('camera-feed');
    const preview = document.getElementById('preview');
    const previewContainer = document.getElementById('preview-container');
    let stream = null;

    // Handle file selection
    actualBtn.addEventListener('change', function () {
        if (this.files && this.files[0]) {
            fileChosen.textContent = this.files[0].name;
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                previewContainer.style.display = 'block';
            };
            reader.readAsDataURL(this.files[0]);
        }
    });

    // Open camera
    cameraBtn.addEventListener('click', function () {
        cameraContainer.style.display = 'block';
        startCamera();
    });

    // Start camera feed
    async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment' // Use back camera on mobile
                } 
            });
            cameraFeed.srcObject = stream;
        } catch (error) {
            console.error('Error accessing camera:', error);
            alert('Unable to access camera. Please check permissions.');
            cameraContainer.style.display = 'none';
        }
    }

    // Close camera
    document.getElementById('close-camera-btn').addEventListener('click', function() {
        stopCamera();
        cameraContainer.style.display = 'none';
        previewContainer.style.display = 'none';
    });

    // Stop camera stream
    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
            cameraFeed.srcObject = null;
        }
    }

    // Capture photo
    captureBtn.addEventListener('click', function () {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        canvas.width = cameraFeed.videoWidth;
        canvas.height = cameraFeed.videoHeight;

        ctx.drawImage(cameraFeed, 0, 0, canvas.width, canvas.height);

        // Convert to blob and create file
        canvas.toBlob(function(blob) {
            const file = new File([blob], "camera_image.jpg", { type: 'image/jpeg' });
            
            // Create DataTransfer and assign to input
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            actualBtn.files = dataTransfer.files;
            
            // Update UI
            fileChosen.textContent = file.name;
            preview.src = URL.createObjectURL(blob);
            previewContainer.style.display = 'block';
            
            // Stop camera
            stopCamera();
            cameraContainer.style.display = 'none';
        }, 'image/jpeg', 0.95);
    });

    // Form validation
    document.getElementById('upload-form').addEventListener('submit', function(e) {
        if (!actualBtn.files || actualBtn.files.length === 0) {
            e.preventDefault();
            alert('Please select an image file first.');
            return false;
        }
    });
</script>

{% endblock body %}